(function(a){for(var b in a)if(!window[b])throw"Error: ThreeRTT requires "+a[b];})({THREE:"Three.js"});window.ThreeRTT=window.ThreeRTT||{};ThreeRTT.getShader=function(a){var b=document.getElementById(a);return b&&b.innerText||a};_.loop=function(a,b){for(var c=0;c<a;++c)b(c)};ThreeRTT.getShader=function(a){var b=document.getElementById(a);return b&&(b.innerText||b.textContent)||a};ThreeRTT.isPowerOfTwo=function(a){return 0===(a&a-1)};
ThreeRTT.toTarget=function(a){return ThreeRTT.Stage&&a instanceof ThreeRTT.Stage?a.target:ThreeRTT.World&&a instanceof ThreeRTT.World?a.target():a};ThreeRTT.toTexture=function(a){a=ThreeRTT.toTarget(a);if(ThreeRTT.RenderTarget&&a instanceof ThreeRTT.RenderTarget)return a.read()};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};
MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger","on","emit"],c=0;c<b.length;c++)a.prototype[b[c]]=MicroEvent.prototype[b[c]]};
ThreeRTT.Stage=function(a,b){b=_.extend({history:0,camera:{},material:!1,scene:null},b);b.camera.aspect=b.camera.aspect||b.width/b.height;this.scene=b.scene||new THREE.Scene;this.camera=ThreeRTT.Camera(b.camera);this.scene.add(this.camera);this.target=new ThreeRTT.RenderTarget(a,b);0<=b.history&&(b.material=b.material||new ThreeRTT.FragmentMaterial(this));b.material&&this.material(b.material)};
ThreeRTT.Stage.prototype={material:function(a){a?(this._surface||(this._surface=new THREE.Mesh(new ThreeRTT.ScreenGeometry,{}),this._surface.frustumCulled=!1,this.scene.add(this._surface)),this._surface.material=a):(this.scene.remove(this._surface),this._surface=null);return this},size:function(a,b){this.camera.aspect=a/b;this.target.size(a,b);return this},read:function(a){return this.target.read(a)},uniform:function(){return this.target.uniform()},render:function(){this.target.clear();this.target.render(this.scene,
this.camera);return this},clear:function(){this.target.clear();return this},destroy:function(){this.target.deallocate();this.target=this.camera=this.scene=null}};ThreeRTT.Compose=function(a,b,c,d,e){b=new ThreeRTT.FragmentMaterial(b,c,d,e);c=new ThreeRTT.ScreenGeometry;b=new THREE.Mesh(c,b);b.frustumCulled=!1;a.add(b);this.scene=a;this.mesh=b};ThreeRTT.Compose.prototype.remove=function(){this.scene.remove(this.mesh)};
ThreeRTT.Camera=function(a){if(a.constructor instanceof THREE.Camera)return a;a=_.extend({aspect:1,far:1E4,fov:85,near:0.01,ortho:!1,scale:1},a);if(a.ortho){var b=a.scale,c=a.aspect;return new THREE.OrthographicCamera(-b*c,b*c,-b,b,a.near,a.far)}return new THREE.PerspectiveCamera(a.fov,a.aspect,a.near,a.far)};
ThreeRTT.RenderTarget=function(a,b){this.options=b=_.extend({width:256,height:256,texture:{},clear:{color:!1,depth:!0,stencil:!0},clearColor:16777215,clearAlpha:1,history:0,scene:null,camera:null,autoAdvance:!0},b);this.renderer=a;if((!ThreeRTT.isPowerOfTwo(b.width)||!ThreeRTT.isPowerOfTwo(b.height))&&!b.texture.minFilter)b.texture.minFilter=THREE.LinearFilter;this.history(this.options.history,!0);this.size(b.width,b.height);this.clear()};
ThreeRTT.RenderTarget.prototype={read:function(a){a=Math.min(this.options.history,Math.abs(a||0));return this.virtuals[a]},write:function(){return this.targets[this.index]},history:function(a,b){void 0!==a&&(this._history=a,this.buffers=a+2,b||this.allocate());return this._history},size:function(a,b){a&&b&&(this.width=Math.floor(a),this.height=Math.floor(b),this.allocate());return{width:this.width,height:this.height}},deallocate:function(){this.deallocateTargets()},allocate:function(){this.deallocateTargets();
this.allocateTargets();this.allocateVirtuals()},deallocateTargets:function(){_.each(this.targets||[],function(a){this.renderer.deallocateRenderTarget(a)}.bind(this))},allocateTargets:function(){var a=this.options;n=this.buffers;var b=this.targets=[];_.loop(n,function(c){b.push(new THREE.WebGLRenderTarget(this.width,this.height,a.texture));b[c].__index=c}.bind(this))},allocateVirtuals:function(){var a=this.targets[0],b=this.virtuals||[];n=this.buffers-1;n>b.length?_.loop(n-b.length,function(){b.push(a.clone())}.bind(this)):
b=b.slice(0,n);_.each(b,function(a,b){a.width=this.width;a.height=this.height;a.__index=b}.bind(this));this.virtuals=b;this.index=-1;this.advance()},advance:function(){var a=this.targets,b=this.virtuals,c=this.index,d=this.buffers;this.index=c=(c+1)%d;_.loop(d-1,function(e){var f=b[e],e=a[(d-1-e+c)%d];f.__webglTexture=e.__webglTexture;f.__webglFramebuffer=e.__webglFramebuffer;f.__webglRenderbuffer=e.__webglRenderbuffer;f.__index=e.__index})},clear:function(){var a=this.options,b=a.clear,c=this.renderer,
d=c.getClearColor().clone(),e=c.getClearAlpha();c.setClearColorHex(a.clearColor,a.clearAlpha);c.clearTarget(this.write(),b.color,b.stencil,b.depth);c.setClearColor(d,e)},render:function(a,b){this.emit("render",a,b);var c=this.renderer.autoClear;this.renderer.autoClear=!1;this.clear();this.renderer.render(a,b,this.write());this.renderer.autoClear=c;this.options.autoAdvance&&this.advance()},uniform:function(a){var b=this.history();if(b){var c=[];_.loop(b+1,function(a){c.push(this.read(-a))}.bind(this));
return{type:"tv",value:a,texture:c,count:b+1}}return{type:"t",value:a,texture:this.read(),count:1}}};MicroEvent.mixin(ThreeRTT.RenderTarget);ThreeRTT.ScreenGeometry=function(){return new THREE.PlaneGeometry(2,2,1,1)};
ThreeRTT.FragmentMaterial=function(a,b,c,d){if(c instanceof Array){var e={};_.each(c,function(a){e["texture"+(i+1)]=a});c=e}else c&&(c={texture1:c});a instanceof Array||(a=[a]);a=_.map(a,function(a){return ThreeRTT.toTarget(a)});d=_.extend(d||{},{sampleStep:{type:"v2",value:new THREE.Vector2}});_.each(c,function(a,b){d[b]={type:"t",value:ThreeRTT.toTexture(a)}});_.each(a,function(a,b){var c="texture"+(b+1);d[c]||(d[c]={type:"t",value:a.read()})});d.texture1&&!d.texture&&(d.texture=d.texture1);a[0].on("render",
function(){var b=d.sampleStep.value;b.x=1/(a[0].width-1);b.y=1/(a[0].height-1)});b=new THREE.ShaderMaterial({uniforms:d,vertexShader:ThreeRTT.getShader("generic-vertex-screen"),fragmentShader:ThreeRTT.getShader(b||"generic-fragment-texture")});b.side=THREE.DoubleSide;return b};
ThreeRTT.DownsampleMaterial=function(a,b){var c={},a=ThreeRTT.toTarget(a),b=ThreeRTT.toTarget(b),c=_.extend(c,{sampleAlignment:{type:"v2",value:new THREE.Vector2},texture:{type:"t",value:0,texture:a.read()}});b.on("render",function(){var d=a,e=b,f=2*e.height/d.height,g=c.sampleAlignment.value;g.x=2*e.width/d.width;g.y=f});return new THREE.ShaderMaterial({uniforms:c,vertexShader:ThreeRTT.getShader("rtt-vertex-downsample"),fragmentShader:ThreeRTT.getShader("generic-fragment-texture")})};
ThreeRTT.RaytraceMaterial=function(a,b,c,d){c instanceof Array?_.each(c,function(){}):c.constructor!=Object&&(c={texture1:c});var a=ThreeRTT.toTarget(a),d=_.extend(d||{},{cameraViewport:{type:"v2",value:new THREE.Vector2},cameraWorld:{type:"m4",value:new THREE.Matrix4}}),e=0;_.each(c||[],function(a,b){d[b]={type:"t",value:e++,texture:ThreeRTT.toTexture(a)}});a.on("render",function(a,b){b.updateMatrixWorld();if(b.fov){var c=Math.tan(b.fov*\u03c0/360);d.cameraViewport.value.set(c*b.aspect,c)}b.matrixWorld&&
(d.cameraWorld.value=b.matrixWorld)});return new THREE.ShaderMaterial({uniforms:d,vertexShader:ThreeRTT.getShader("generic-vertex-screen"),fragmentShader:ThreeRTT.getShader(b)})};
ThreeRTT.World=function(a,b){b=b||{};b=_.extend({autoRendering:!0,autoSize:!(b.width&&b.height),order:++ThreeRTT.World.sequence,scale:1},b);b.width=!b.autoSize&&b.width||(a._opts&&a._opts.renderW||256)/b.scale;b.height=!b.autoSize&&b.height||(a._opts&&a._opts.renderH||256)/b.scale;a.on("resize",function(a,d){b.autoSize&&(a/=b.scale,d/=b.scale,this.size(a,d))}.bind(this));this._options=b;this._world=a;this._autoRendering=b.autoRendering;this._renderer=a.tRenderer();this._stage=new ThreeRTT.Stage(this._renderer,
b);this._scene=this._stage.scene;this._camera=this._stage.camera;this.queue=ThreeRTT.RenderQueue.bind(a);this.queue.add(this);this.size(b.width,b.height,!0)};ThreeRTT.World.sequence=1E5;
ThreeRTT.World.prototype=_.extend(new THREE.Object3D,tQuery.World.prototype,{stage:function(){return this._stage},target:function(){return this._stage.target},autoSize:function(a){void 0!==a&&(this._options.autoSize=a);return this._options.autoSize},scale:function(a){if(a){this._options.scale=a;if(this._options.autoSize){var b=this._world._opts;this.size(b.renderW/a,b.renderH/a)}return this}return this._options.scale},size:function(a,b,c){return a&&b?(this._options.width=a,this._options.height=b,
this._opts={renderW:a,renderH:b},c||this._stage.size(a,b),this):{width:this._options.width,height:this._options.height}},material:function(a){this._stage.material(a);return this},read:function(a){return this._stage.read(a)},uniform:function(){return this._stage.uniform()},render:function(){this._autoRendering&&this._stage.render();return this},update:function(){this._autoRendering||this._stage.render()},destroy:function(){this._stage.destroy();this._stage=null;this.queue.remove(this);this.trigger("destroy");
return this}});tQuery.pluginsInstanceOn(ThreeRTT.World);tQuery.MicroeventMixin(ThreeRTT.World.prototype);ThreeRTT.RenderQueue=function(a){this.world=a;this.queue=[];this.callback=null;this.renderer=a.tRenderer()};
ThreeRTT.RenderQueue.prototype={add:function(a){this.queue.push(a);this.sort();this.init()},remove:function(a){this.queue.splice(this.queue.indexOf(a),1);this.cleanup()},init:function(){var a=this.queue,b=this.world;a.length&&!this.callback&&b.loop().hookPreRender(this.callback=function(){_.each(a,function(a){a.render()})})},cleanup:function(){var a=this.world;!this.queue.length&&this.callback&&(a.loop().unhookPreRender(this.callback),this.callback=null)},sort:function(){this.queue.sort(function(a,
b){return a.order-b.order})}};ThreeRTT.RenderQueue.bind=function(a){return a.__rttRenderQueue?a.__rttRenderQueue:a.__rttRenderQueue=new ThreeRTT.RenderQueue(a)};tQuery.World.registerInstance("rtt",function(a){return tQuery.createRTT(this,a)});tQuery.World.registerInstance("compose",function(a,b,c,d){tQuery.composeRTT(this,a,b,c,d);return this});ThreeRTT.World.registerInstance("fragment",function(a,b,c){this.material(tQuery.createFragmentMaterial(this,a,b,c));return this});
ThreeRTT.World.registerInstance("raytrace",function(a,b,c){this.material(tQuery.createRaytraceMaterial(this,a,b,c));return this});ThreeRTT.World.registerInstance("downsample",function(a){var b=a.scale();this.scale(2*b);a.autoSize||(b=a.size(),this.size(b.width/2,b.height/2));this.material(tQuery.createDownsampleMaterial(a,this));return this});tQuery.registerStatic("createRTT",function(a,b){return new ThreeRTT.World(a,b)});
tQuery.registerStatic("composeRTT",function(a,b,c,d,e){return new ThreeRTT.Compose(a.tScene(),b,c,d,e)});tQuery.registerStatic("createFragmentMaterial",function(a,b,c,d){return new ThreeRTT.FragmentMaterial(a,b,c,d)});tQuery.registerStatic("createRaytraceMaterial",function(a,b,c,d){return new ThreeRTT.RaytraceMaterial(a,b,c,d)});tQuery.registerStatic("createDownsampleMaterial",function(a,b){return new ThreeRTT.DownsampleMaterial(a,b)});
