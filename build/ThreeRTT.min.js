(function(){function d(a,f,k){if(a===f)return 0!==a||1/a==1/f;if(null==a||null==f)return a===f;a._chain&&(a=a._wrapped);f._chain&&(f=f._wrapped);if(a.isEqual&&c.isFunction(a.isEqual))return a.isEqual(f);if(f.isEqual&&c.isFunction(f.isEqual))return f.isEqual(a);var u=p.call(a);if(u!=p.call(f))return!1;switch(u){case "[object String]":return a==""+f;case "[object Number]":return a!=+a?f!=+f:0==a?1/a==1/f:a==+f;case "[object Date]":case "[object Boolean]":return+a==+f;case "[object RegExp]":return a.source==
f.source&&a.global==f.global&&a.multiline==f.multiline&&a.ignoreCase==f.ignoreCase}if("object"!=typeof a||"object"!=typeof f)return!1;for(var b=k.length;b--;)if(k[b]==a)return!0;k.push(a);var b=0,r=!0;if("[object Array]"==u){if(b=a.length,r=b==f.length)for(;b--&&(r=b in a==b in f&&d(a[b],f[b],k)););}else{if("constructor"in a!="constructor"in f||a.constructor!=f.constructor)return!1;for(var e in a)if(c.has(a,e)&&(b++,!(r=c.has(f,e)&&d(a[e],f[e],k))))break;if(r){for(e in f)if(c.has(f,e)&&!b--)break;
r=!b}}k.pop();return r}var b=this,e=b._,g={},h=Array.prototype,m=Object.prototype,j=h.slice,K=h.unshift,p=m.toString,L=m.hasOwnProperty,A=h.forEach,B=h.map,C=h.reduce,D=h.reduceRight,E=h.filter,F=h.every,G=h.some,t=h.indexOf,H=h.lastIndexOf,m=Array.isArray,M=Object.keys,v=Function.prototype.bind,c=function(a){return new q(a)};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=c),exports._=c):b._=c;c.VERSION="1.3.3";var l=c.each=c.forEach=function(a,
f,k){if(null!=a)if(A&&a.forEach===A)a.forEach(f,k);else if(a.length===+a.length)for(var b=0,d=a.length;b<d&&!(b in a&&f.call(k,a[b],b,a)===g);b++);else for(b in a)if(c.has(a,b)&&f.call(k,a[b],b,a)===g)break};c.map=c.collect=function(a,f,c){var b=[];if(null==a)return b;if(B&&a.map===B)return a.map(f,c);l(a,function(a,d,e){b[b.length]=f.call(c,a,d,e)});a.length===+a.length&&(b.length=a.length);return b};c.reduce=c.foldl=c.inject=function(a,f,k,b){var d=2<arguments.length;null==a&&(a=[]);if(C&&a.reduce===
C)return b&&(f=c.bind(f,b)),d?a.reduce(f,k):a.reduce(f);l(a,function(a,c,e){d?k=f.call(b,k,a,c,e):(k=a,d=!0)});if(!d)throw new TypeError("Reduce of empty array with no initial value");return k};c.reduceRight=c.foldr=function(a,f,k,b){var d=2<arguments.length;null==a&&(a=[]);if(D&&a.reduceRight===D)return b&&(f=c.bind(f,b)),d?a.reduceRight(f,k):a.reduceRight(f);var e=c.toArray(a).reverse();b&&!d&&(f=c.bind(f,b));return d?c.reduce(e,f,k,b):c.reduce(e,f)};c.find=c.detect=function(a,f,c){var b;I(a,function(a,
d,e){if(f.call(c,a,d,e))return b=a,!0});return b};c.filter=c.select=function(a,f,c){var b=[];if(null==a)return b;if(E&&a.filter===E)return a.filter(f,c);l(a,function(a,d,e){f.call(c,a,d,e)&&(b[b.length]=a)});return b};c.reject=function(a,f,c){var b=[];if(null==a)return b;l(a,function(a,d,e){f.call(c,a,d,e)||(b[b.length]=a)});return b};c.every=c.all=function(a,f,c){var b=!0;if(null==a)return b;if(F&&a.every===F)return a.every(f,c);l(a,function(a,d,e){if(!(b=b&&f.call(c,a,d,e)))return g});return!!b};
var I=c.some=c.any=function(a,f,b){f||(f=c.identity);var d=!1;if(null==a)return d;if(G&&a.some===G)return a.some(f,b);l(a,function(a,c,e){if(d||(d=f.call(b,a,c,e)))return g});return!!d};c.include=c.contains=function(a,f){return null==a?!1:t&&a.indexOf===t?-1!=a.indexOf(f):I(a,function(a){return a===f})};c.invoke=function(a,f){var b=j.call(arguments,2);return c.map(a,function(a){return(c.isFunction(f)?f||a:a[f]).apply(a,b)})};c.pluck=function(a,f){return c.map(a,function(a){return a[f]})};c.max=function(a,
f,b){if(!f&&c.isArray(a)&&a[0]===+a[0])return Math.max.apply(Math,a);if(!f&&c.isEmpty(a))return-Infinity;var d={computed:-Infinity};l(a,function(a,c,e){c=f?f.call(b,a,c,e):a;c>=d.computed&&(d={value:a,computed:c})});return d.value};c.min=function(a,f,b){if(!f&&c.isArray(a)&&a[0]===+a[0])return Math.min.apply(Math,a);if(!f&&c.isEmpty(a))return Infinity;var d={computed:Infinity};l(a,function(a,c,e){c=f?f.call(b,a,c,e):a;c<d.computed&&(d={value:a,computed:c})});return d.value};c.shuffle=function(a){var c=
[],b;l(a,function(a,d){b=Math.floor(Math.random()*(d+1));c[d]=c[b];c[b]=a});return c};c.sortBy=function(a,f,b){var d=c.isFunction(f)?f:function(a){return a[f]};return c.pluck(c.map(a,function(a,c,f){return{value:a,criteria:d.call(b,a,c,f)}}).sort(function(a,c){var f=a.criteria,b=c.criteria;return void 0===f?1:void 0===b?-1:f<b?-1:f>b?1:0}),"value")};c.groupBy=function(a,f){var b={},d=c.isFunction(f)?f:function(a){return a[f]};l(a,function(a,c){var f=d(a,c);(b[f]||(b[f]=[])).push(a)});return b};c.sortedIndex=
function(a,f,b){b||(b=c.identity);for(var d=0,e=a.length;d<e;){var g=d+e>>1;b(a[g])<b(f)?d=g+1:e=g}return d};c.toArray=function(a){return!a?[]:c.isArray(a)||c.isArguments(a)?j.call(a):a.toArray&&c.isFunction(a.toArray)?a.toArray():c.values(a)};c.size=function(a){return c.isArray(a)?a.length:c.keys(a).length};c.first=c.head=c.take=function(a,c,b){return null!=c&&!b?j.call(a,0,c):a[0]};c.initial=function(a,c,b){return j.call(a,0,a.length-(null==c||b?1:c))};c.last=function(a,c,b){return null!=c&&!b?
j.call(a,Math.max(a.length-c,0)):a[a.length-1]};c.rest=c.tail=function(a,c,b){return j.call(a,null==c||b?1:c)};c.compact=function(a){return c.filter(a,function(a){return!!a})};c.flatten=function(a,b){return c.reduce(a,function(a,d){if(c.isArray(d))return a.concat(b?d:c.flatten(d));a[a.length]=d;return a},[])};c.without=function(a){return c.difference(a,j.call(arguments,1))};c.uniq=c.unique=function(a,b,d){var d=d?c.map(a,d):a,e=[];3>a.length&&(b=!0);c.reduce(d,function(d,k,g){if(b?c.last(d)!==k||
!d.length:!c.include(d,k))d.push(k),e.push(a[g]);return d},[]);return e};c.union=function(){return c.uniq(c.flatten(arguments,!0))};c.intersection=c.intersect=function(a){var b=j.call(arguments,1);return c.filter(c.uniq(a),function(a){return c.every(b,function(b){return 0<=c.indexOf(b,a)})})};c.difference=function(a){var b=c.flatten(j.call(arguments,1),!0);return c.filter(a,function(a){return!c.include(b,a)})};c.zip=function(){for(var a=j.call(arguments),b=c.max(c.pluck(a,"length")),d=Array(b),e=
0;e<b;e++)d[e]=c.pluck(a,""+e);return d};c.indexOf=function(a,b,d){if(null==a)return-1;var e;if(d)return d=c.sortedIndex(a,b),a[d]===b?d:-1;if(t&&a.indexOf===t)return a.indexOf(b);d=0;for(e=a.length;d<e;d++)if(d in a&&a[d]===b)return d;return-1};c.lastIndexOf=function(a,c){if(null==a)return-1;if(H&&a.lastIndexOf===H)return a.lastIndexOf(c);for(var b=a.length;b--;)if(b in a&&a[b]===c)return b;return-1};c.range=function(a,c,b){1>=arguments.length&&(c=a||0,a=0);for(var b=arguments[2]||1,d=Math.max(Math.ceil((c-
a)/b),0),e=0,g=Array(d);e<d;)g[e++]=a,a+=b;return g};var J=function(){};c.bind=function(a,b){var d,e;if(a.bind===v&&v)return v.apply(a,j.call(arguments,1));if(!c.isFunction(a))throw new TypeError;e=j.call(arguments,2);return d=function(){if(!(this instanceof d))return a.apply(b,e.concat(j.call(arguments)));J.prototype=a.prototype;var c=new J,g=a.apply(c,e.concat(j.call(arguments)));return Object(g)===g?g:c}};c.bindAll=function(a){var b=j.call(arguments,1);0==b.length&&(b=c.functions(a));l(b,function(b){a[b]=
c.bind(a[b],a)});return a};c.memoize=function(a,b){var d={};b||(b=c.identity);return function(){var e=b.apply(this,arguments);return c.has(d,e)?d[e]:d[e]=a.apply(this,arguments)}};c.delay=function(a,b){var c=j.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)};c.defer=function(a){return c.delay.apply(c,[a,1].concat(j.call(arguments,1)))};c.throttle=function(a,b){var d,e,g,j,h,m,l=c.debounce(function(){h=j=!1},b);return function(){d=this;e=arguments;g||(g=setTimeout(function(){g=
null;h&&a.apply(d,e);l()},b));j?h=!0:m=a.apply(d,e);l();j=!0;return m}};c.debounce=function(a,b,c){var d;return function(){var e=this,g=arguments;c&&!d&&a.apply(e,g);clearTimeout(d);d=setTimeout(function(){d=null;c||a.apply(e,g)},b)}};c.once=function(a){var b=!1,c;return function(){if(b)return c;b=!0;return c=a.apply(this,arguments)}};c.wrap=function(a,b){return function(){var c=[a].concat(j.call(arguments,0));return b.apply(this,c)}};c.compose=function(){var a=arguments;return function(){for(var b=
arguments,c=a.length-1;0<=c;c--)b=[a[c].apply(this,b)];return b[0]}};c.after=function(a,b){return 0>=a?b():function(){if(1>--a)return b.apply(this,arguments)}};c.keys=M||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[],d;for(d in a)c.has(a,d)&&(b[b.length]=d);return b};c.values=function(a){return c.map(a,c.identity)};c.functions=c.methods=function(a){var b=[],d;for(d in a)c.isFunction(a[d])&&b.push(d);return b.sort()};c.extend=function(a){l(j.call(arguments,1),function(b){for(var c in b)a[c]=
b[c]});return a};c.pick=function(a){var b={};l(c.flatten(j.call(arguments,1)),function(c){c in a&&(b[c]=a[c])});return b};c.defaults=function(a){l(j.call(arguments,1),function(b){for(var c in b)null==a[c]&&(a[c]=b[c])});return a};c.clone=function(a){return!c.isObject(a)?a:c.isArray(a)?a.slice():c.extend({},a)};c.tap=function(a,b){b(a);return a};c.isEqual=function(a,b){return d(a,b,[])};c.isEmpty=function(a){if(null==a)return!0;if(c.isArray(a)||c.isString(a))return 0===a.length;for(var b in a)if(c.has(a,
b))return!1;return!0};c.isElement=function(a){return!!(a&&1==a.nodeType)};c.isArray=m||function(a){return"[object Array]"==p.call(a)};c.isObject=function(a){return a===Object(a)};c.isArguments=function(a){return"[object Arguments]"==p.call(a)};c.isArguments(arguments)||(c.isArguments=function(a){return!(!a||!c.has(a,"callee"))});c.isFunction=function(a){return"[object Function]"==p.call(a)};c.isString=function(a){return"[object String]"==p.call(a)};c.isNumber=function(a){return"[object Number]"==
p.call(a)};c.isFinite=function(a){return c.isNumber(a)&&isFinite(a)};c.isNaN=function(a){return a!==a};c.isBoolean=function(a){return!0===a||!1===a||"[object Boolean]"==p.call(a)};c.isDate=function(a){return"[object Date]"==p.call(a)};c.isRegExp=function(a){return"[object RegExp]"==p.call(a)};c.isNull=function(a){return null===a};c.isUndefined=function(a){return void 0===a};c.has=function(a,b){return L.call(a,b)};c.noConflict=function(){b._=e;return this};c.identity=function(a){return a};c.times=
function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)};c.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};c.result=function(a,b){if(null==a)return null;var d=a[b];return c.isFunction(d)?d.call(a):d};c.mixin=function(a){l(c.functions(a),function(b){var d=c[b]=a[b];q.prototype[b]=function(){var a=j.call(arguments);K.call(a,this._wrapped);return w(d.apply(c,a),this._chain)}})};var N=0;c.uniqueId=
function(a){var b=N++;return a?a+b:b};c.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var x=/.^/,s={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"},y;for(y in s)s[s[y]]=y;var O=/\\|'|\r|\n|\t|\u2028|\u2029/g,P=/\\(\\|'|r|n|t|u2028|u2029)/g,z=function(a){return a.replace(P,function(a,b){return s[b]})};c.template=function(a,b,d){d=c.defaults(d||{},c.templateSettings);a="__p+='"+a.replace(O,function(a){return"\\"+s[a]}).replace(d.escape||
x,function(a,b){return"'+\n_.escape("+z(b)+")+\n'"}).replace(d.interpolate||x,function(a,b){return"'+\n("+z(b)+")+\n'"}).replace(d.evaluate||x,function(a,b){return"';\n"+z(b)+"\n;__p+='"})+"';\n";d.variable||(a="with(obj||{}){\n"+a+"}\n");var a="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+a+"return __p;\n",e=new Function(d.variable||"obj","_",a);if(b)return e(b,c);b=function(a){return e.call(this,a,c)};b.source="function("+(d.variable||"obj")+"){\n"+a+"}";return b};
c.chain=function(a){return c(a).chain()};var q=function(a){this._wrapped=a};c.prototype=q.prototype;var w=function(a,b){return b?c(a).chain():a};c.mixin(c);l("pop push reverse shift sort splice unshift".split(" "),function(a){var b=h[a];q.prototype[a]=function(){var c=this._wrapped;b.apply(c,arguments);var d=c.length;("shift"==a||"splice"==a)&&0===d&&delete c[0];return w(c,this._chain)}});l(["concat","join","slice"],function(a){var b=h[a];q.prototype[a]=function(){return w(b.apply(this._wrapped,arguments),
this._chain)}});q.prototype.chain=function(){this._chain=!0;return this};q.prototype.value=function(){return this._wrapped}}).call(this);var MicroEvent=function(){};
MicroEvent.prototype={bind:function(d,b){this._events=this._events||{};this._events[d]=this._events[d]||[];this._events[d].push(b)},unbind:function(d,b){this._events=this._events||{};!1!==d in this._events&&this._events[d].splice(this._events[d].indexOf(b),1)},trigger:function(d){this._events=this._events||{};if(!1!==d in this._events)for(var b=0;b<this._events[d].length;b++)this._events[d][b].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(d){for(var b=["bind","unbind","trigger"],e=0;e<b.length;e++)d.prototype[b[e]]=MicroEvent.prototype[b[e]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);(function(d){for(var b in d)if(!window[b])throw"Error: ThreeRTT requires "+d[b];})({THREE:"Three.js"});window.ThreeRTT=window.ThreeRTT||{};ThreeRTT.getShader=function(d){var b=document.getElementById(d);return b&&b.innerText||d};_.loop=function(d,b){for(var e=0;e<d;++e)b(e)};
ThreeRTT.getShader=function(d){var b=document.getElementById(d);return b&&(b.innerText||b.textContent)||d};ThreeRTT.isPowerOfTwo=function(d){return 0===(d&d-1)};ThreeRTT.toTarget=function(d){return ThreeRTT.Stage&&d instanceof ThreeRTT.Stage?d.target:ThreeRTT.World&&d instanceof ThreeRTT.World?d.target():d};ThreeRTT.toTexture=function(d){d=ThreeRTT.toTarget(d);if(ThreeRTT.RenderTarget&&d instanceof ThreeRTT.RenderTarget)return d.read()};
MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};MicroEvent.mixin=function(d){for(var b=["bind","unbind","trigger","on","emit"],e=0;e<b.length;e++)d.prototype[b[e]]=MicroEvent.prototype[b[e]]};
ThreeRTT.Stage=function(d,b){b=_.extend({history:0,camera:{},material:!1,scene:null},b);b.camera.aspect=b.camera.aspect||b.width/b.height;this.scene=b.scene||new THREE.Scene;this.camera=ThreeRTT.Camera(b.camera);this.scene.add(this.camera);this.target=new ThreeRTT.RenderTarget(d,b);0<=b.history&&(b.material=b.material||new ThreeRTT.FragmentMaterial(this));b.material&&this.material(b.material)};
ThreeRTT.Stage.prototype={material:function(d){d?(this._surface||(this._surface=new THREE.Mesh(new ThreeRTT.ScreenGeometry,{}),this._surface.frustumCulled=!1,this.scene.add(this._surface)),this._surface.material=d):(this.scene.remove(this._surface),this._surface=null);return this},size:function(d,b){this.camera.aspect=d/b;this.target.size(d,b);return this},read:function(d){return this.target.read(d)},uniform:function(){return this.target.uniform()},render:function(){this.target.clear();this.target.render(this.scene,
this.camera);return this},clear:function(){this.target.clear();return this},destroy:function(){this.target.deallocate();this.target=this.camera=this.scene=null}};ThreeRTT.Compose=function(d,b,e,g,h){b=new ThreeRTT.FragmentMaterial(b,e,g,h);e=new ThreeRTT.ScreenGeometry;b=new THREE.Mesh(e,b);b.frustumCulled=!1;d.add(b);this.scene=d;this.mesh=b};ThreeRTT.Compose.prototype.remove=function(){this.scene.remove(this.mesh)};
ThreeRTT.Camera=function(d){if(d.constructor instanceof THREE.Camera)return d;d=_.extend({aspect:1,far:1E4,fov:85,near:0.01,ortho:!1,scale:1},d);if(d.ortho){var b=d.scale,e=d.aspect;return new THREE.OrthographicCamera(-b*e,b*e,-b,b,d.near,d.far)}return new THREE.PerspectiveCamera(d.fov,d.aspect,d.near,d.far)};
ThreeRTT.RenderTarget=function(d,b){this.options=b=_.extend({width:256,height:256,texture:{},clear:{color:!1,depth:!0,stencil:!0},clearColor:16777215,clearAlpha:1,history:0,scene:null,camera:null,autoAdvance:!0},b);this.renderer=d;if((!ThreeRTT.isPowerOfTwo(b.width)||!ThreeRTT.isPowerOfTwo(b.height))&&!b.texture.minFilter)b.texture.minFilter=THREE.LinearFilter;this.history(this.options.history,!0);this.size(b.width,b.height);this.clear()};
ThreeRTT.RenderTarget.prototype={read:function(d){d=Math.min(this.options.history,Math.abs(d||0));return this.virtuals[d]},write:function(){return this.targets[this.index]},history:function(d,b){void 0!==d&&(this._history=d,this.buffers=d+2,b||this.allocate());return this._history},size:function(d,b){d&&b&&(this.width=Math.floor(d),this.height=Math.floor(b),this.allocate());return{width:this.width,height:this.height}},deallocate:function(){this.deallocateTargets()},allocate:function(){this.deallocateTargets();
this.allocateTargets();this.allocateVirtuals()},deallocateTargets:function(){_.each(this.targets||[],function(d){this.renderer.deallocateRenderTarget(d)}.bind(this))},allocateTargets:function(){var d=this.options;n=this.buffers;var b=this.targets=[];_.loop(n,function(e){b.push(new THREE.WebGLRenderTarget(this.width,this.height,d.texture));b[e].__index=e}.bind(this))},allocateVirtuals:function(){var d=this.targets[0],b=this.virtuals||[];n=this.buffers-1;n>b.length?_.loop(n-b.length,function(){b.push(d.clone())}.bind(this)):
b=b.slice(0,n);_.each(b,function(b,d){b.width=this.width;b.height=this.height;b.__index=d}.bind(this));this.virtuals=b;this.index=-1;this.advance()},advance:function(){var d=this.targets,b=this.virtuals,e=this.index,g=this.buffers;this.index=e=(e+1)%g;_.loop(g-1,function(h){var m=b[h],h=d[(g-1-h+e)%g];m.__webglTexture=h.__webglTexture;m.__webglFramebuffer=h.__webglFramebuffer;m.__webglRenderbuffer=h.__webglRenderbuffer;m.__index=h.__index})},clear:function(){var d=this.options,b=d.clear,e=this.renderer,
g=e.getClearColor().clone(),h=e.getClearAlpha();e.setClearColorHex(d.clearColor,d.clearAlpha);e.clearTarget(this.write(),b.color,b.stencil,b.depth);e.setClearColor(g,h)},render:function(d,b){this.emit("render",d,b);var e=this.renderer.autoClear;this.renderer.autoClear=!1;this.clear();this.renderer.render(d,b,this.write());this.renderer.autoClear=e;this.options.autoAdvance&&this.advance()},uniform:function(d){var b=this.history();if(b){var e=[];_.loop(b+1,function(b){e.push(this.read(-b))}.bind(this));
return{type:"tv",value:d,texture:e,count:b+1}}return{type:"t",value:d,texture:this.read(),count:1}}};MicroEvent.mixin(ThreeRTT.RenderTarget);ThreeRTT.ScreenGeometry=function(){return new THREE.PlaneGeometry(2,2,1,1)};
ThreeRTT.FragmentMaterial=function(d,b,e,g){e=e||{};if(e instanceof Array){var h={};_.each(e,function(b){h["texture"+(i+1)]=b});e=h}else e.constructor!=Object&&(e={texture1:e});d instanceof Array||(d=[d]);d=_.map(d,function(b){return ThreeRTT.toTarget(b)});g=_.extend(g||{},{sampleStep:{type:"v2",value:new THREE.Vector2}});_.each(e,function(b,d){g[d]={type:"t",value:ThreeRTT.toTexture(b)}});_.each(d,function(b,d){var e="texture"+(d+1);g[e]||(g[e]={type:"t",value:b.read()})});g.texture1&&!g.texture&&
(g.texture=g.texture1);d[0].on("render",function(){var b=g.sampleStep.value;b.x=1/(d[0].width-1);b.y=1/(d[0].height-1)});b=new THREE.ShaderMaterial({uniforms:g,vertexShader:ThreeRTT.getShader("generic-vertex-screen"),fragmentShader:ThreeRTT.getShader(b||"generic-fragment-texture")});b.side=THREE.DoubleSide;b.depthTest=!1;b.depthWrite=!1;b.transparent=!0;return b};
ThreeRTT.DownsampleMaterial=function(d,b){var e={},d=ThreeRTT.toTarget(d),b=ThreeRTT.toTarget(b),e=_.extend(e,{sampleAlignment:{type:"v2",value:new THREE.Vector2},texture:{type:"t",value:0,texture:d.read()}});b.on("render",function(){var g=d,h=b,m=2*h.height/g.height,j=e.sampleAlignment.value;j.x=2*h.width/g.width;j.y=m});return new THREE.ShaderMaterial({uniforms:e,vertexShader:ThreeRTT.getShader("rtt-vertex-downsample"),fragmentShader:ThreeRTT.getShader("generic-fragment-texture")})};
ThreeRTT.RaytraceMaterial=function(d,b,e,g){e instanceof Array?_.each(e,function(){}):e.constructor!=Object&&(e={texture1:e});var d=ThreeRTT.toTarget(d),g=_.extend(g||{},{cameraViewport:{type:"v2",value:new THREE.Vector2},cameraWorld:{type:"m4",value:new THREE.Matrix4}}),h=0;_.each(e||[],function(b,d){g[d]={type:"t",value:h++,texture:ThreeRTT.toTexture(b)}});d.on("render",function(b,d){d.updateMatrixWorld();if(d.fov){var e=Math.tan(d.fov*\u03c0/360);g.cameraViewport.value.set(e*d.aspect,e)}d.matrixWorld&&
(g.cameraWorld.value=d.matrixWorld)});return new THREE.ShaderMaterial({uniforms:g,vertexShader:ThreeRTT.getShader("generic-vertex-screen"),fragmentShader:ThreeRTT.getShader(b)})};
