(function(){function c(a,g,b){if(a===g)return 0!==a||1/a==1/g;if(null==a||null==g)return a===g;a._chain&&(a=a._wrapped);g._chain&&(g=g._wrapped);if(a.isEqual&&d.isFunction(a.isEqual))return a.isEqual(g);if(g.isEqual&&d.isFunction(g.isEqual))return g.isEqual(a);var x=m.call(a);if(x!=m.call(g))return!1;switch(x){case "[object String]":return a==""+g;case "[object Number]":return a!=+a?g!=+g:0==a?1/a==1/g:a==+g;case "[object Date]":case "[object Boolean]":return+a==+g;case "[object RegExp]":return a.source==
g.source&&a.global==g.global&&a.multiline==g.multiline&&a.ignoreCase==g.ignoreCase}if("object"!=typeof a||"object"!=typeof g)return!1;for(var e=b.length;e--;)if(b[e]==a)return!0;b.push(a);var e=0,p=!0;if("[object Array]"==x){if(e=a.length,p=e==g.length)for(;e--&&(p=e in a==e in g&&c(a[e],g[e],b)););}else{if("constructor"in a!="constructor"in g||a.constructor!=g.constructor)return!1;for(var f in a)if(d.has(a,f)&&(e++,!(p=d.has(g,f)&&c(a[f],g[f],b))))break;if(p){for(f in g)if(d.has(g,f)&&!e--)break;
p=!e}}b.pop();return p}var b=this,e=b._,f={},j=Array.prototype,l=Object.prototype,h=j.slice,s=j.unshift,m=l.toString,t=l.hasOwnProperty,q=j.forEach,D=j.map,E=j.reduce,F=j.reduceRight,G=j.filter,H=j.every,I=j.some,v=j.indexOf,J=j.lastIndexOf,l=Array.isArray,M=Object.keys,y=Function.prototype.bind,d=function(a){return new r(a)};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=d),exports._=d):b._=d;d.VERSION="1.3.3";var k=d.each=d.forEach=function(a,
g,c){if(null!=a)if(q&&a.forEach===q)a.forEach(g,c);else if(a.length===+a.length)for(var b=0,e=a.length;b<e&&!(b in a&&g.call(c,a[b],b,a)===f);b++);else for(b in a)if(d.has(a,b)&&g.call(c,a[b],b,a)===f)break};d.map=d.collect=function(a,g,c){var b=[];if(null==a)return b;if(D&&a.map===D)return a.map(g,c);k(a,function(a,d,e){b[b.length]=g.call(c,a,d,e)});a.length===+a.length&&(b.length=a.length);return b};d.reduce=d.foldl=d.inject=function(a,g,c,b){var e=2<arguments.length;null==a&&(a=[]);if(E&&a.reduce===
E)return b&&(g=d.bind(g,b)),e?a.reduce(g,c):a.reduce(g);k(a,function(a,d,f){e?c=g.call(b,c,a,d,f):(c=a,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return c};d.reduceRight=d.foldr=function(a,g,c,b){var e=2<arguments.length;null==a&&(a=[]);if(F&&a.reduceRight===F)return b&&(g=d.bind(g,b)),e?a.reduceRight(g,c):a.reduceRight(g);var p=d.toArray(a).reverse();b&&!e&&(g=d.bind(g,b));return e?d.reduce(p,g,c,b):d.reduce(p,g)};d.find=d.detect=function(a,g,c){var b;K(a,function(a,
d,e){if(g.call(c,a,d,e))return b=a,!0});return b};d.filter=d.select=function(a,g,c){var b=[];if(null==a)return b;if(G&&a.filter===G)return a.filter(g,c);k(a,function(a,d,e){g.call(c,a,d,e)&&(b[b.length]=a)});return b};d.reject=function(a,b,c){var d=[];if(null==a)return d;k(a,function(a,e,f){b.call(c,a,e,f)||(d[d.length]=a)});return d};d.every=d.all=function(a,b,c){var d=!0;if(null==a)return d;if(H&&a.every===H)return a.every(b,c);k(a,function(a,e,h){if(!(d=d&&b.call(c,a,e,h)))return f});return!!d};
var K=d.some=d.any=function(a,b,c){b||(b=d.identity);var e=!1;if(null==a)return e;if(I&&a.some===I)return a.some(b,c);k(a,function(a,d,h){if(e||(e=b.call(c,a,d,h)))return f});return!!e};d.include=d.contains=function(a,b){return null==a?!1:v&&a.indexOf===v?-1!=a.indexOf(b):K(a,function(a){return a===b})};d.invoke=function(a,b){var c=h.call(arguments,2);return d.map(a,function(a){return(d.isFunction(b)?b||a:a[b]).apply(a,c)})};d.pluck=function(a,b){return d.map(a,function(a){return a[b]})};d.max=function(a,
b,c){if(!b&&d.isArray(a)&&a[0]===+a[0])return Math.max.apply(Math,a);if(!b&&d.isEmpty(a))return-Infinity;var e={computed:-Infinity};k(a,function(a,d,f){d=b?b.call(c,a,d,f):a;d>=e.computed&&(e={value:a,computed:d})});return e.value};d.min=function(a,b,c){if(!b&&d.isArray(a)&&a[0]===+a[0])return Math.min.apply(Math,a);if(!b&&d.isEmpty(a))return Infinity;var e={computed:Infinity};k(a,function(a,d,f){d=b?b.call(c,a,d,f):a;d<e.computed&&(e={value:a,computed:d})});return e.value};d.shuffle=function(a){var b=
[],c;k(a,function(a,d){c=Math.floor(Math.random()*(d+1));b[d]=b[c];b[c]=a});return b};d.sortBy=function(a,b,c){var e=d.isFunction(b)?b:function(a){return a[b]};return d.pluck(d.map(a,function(a,b,d){return{value:a,criteria:e.call(c,a,b,d)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;return void 0===c?1:void 0===d?-1:c<d?-1:c>d?1:0}),"value")};d.groupBy=function(a,b){var c={},e=d.isFunction(b)?b:function(a){return a[b]};k(a,function(a,b){var d=e(a,b);(c[d]||(c[d]=[])).push(a)});return c};d.sortedIndex=
function(a,b,c){c||(c=d.identity);for(var e=0,f=a.length;e<f;){var h=e+f>>1;c(a[h])<c(b)?e=h+1:f=h}return e};d.toArray=function(a){return!a?[]:d.isArray(a)||d.isArguments(a)?h.call(a):a.toArray&&d.isFunction(a.toArray)?a.toArray():d.values(a)};d.size=function(a){return d.isArray(a)?a.length:d.keys(a).length};d.first=d.head=d.take=function(a,b,c){return null!=b&&!c?h.call(a,0,b):a[0]};d.initial=function(a,b,c){return h.call(a,0,a.length-(null==b||c?1:b))};d.last=function(a,b,c){return null!=b&&!c?
h.call(a,Math.max(a.length-b,0)):a[a.length-1]};d.rest=d.tail=function(a,b,c){return h.call(a,null==b||c?1:b)};d.compact=function(a){return d.filter(a,function(a){return!!a})};d.flatten=function(a,b){return d.reduce(a,function(a,c){if(d.isArray(c))return a.concat(b?c:d.flatten(c));a[a.length]=c;return a},[])};d.without=function(a){return d.difference(a,h.call(arguments,1))};d.uniq=d.unique=function(a,b,c){var c=c?d.map(a,c):a,e=[];3>a.length&&(b=!0);d.reduce(c,function(c,w,f){if(b?d.last(c)!==w||
!c.length:!d.include(c,w))c.push(w),e.push(a[f]);return c},[]);return e};d.union=function(){return d.uniq(d.flatten(arguments,!0))};d.intersection=d.intersect=function(a){var b=h.call(arguments,1);return d.filter(d.uniq(a),function(a){return d.every(b,function(b){return 0<=d.indexOf(b,a)})})};d.difference=function(a){var b=d.flatten(h.call(arguments,1),!0);return d.filter(a,function(a){return!d.include(b,a)})};d.zip=function(){for(var a=h.call(arguments),b=d.max(d.pluck(a,"length")),c=Array(b),e=
0;e<b;e++)c[e]=d.pluck(a,""+e);return c};d.indexOf=function(a,b,c){if(null==a)return-1;var e;if(c)return c=d.sortedIndex(a,b),a[c]===b?c:-1;if(v&&a.indexOf===v)return a.indexOf(b);c=0;for(e=a.length;c<e;c++)if(c in a&&a[c]===b)return c;return-1};d.lastIndexOf=function(a,b){if(null==a)return-1;if(J&&a.lastIndexOf===J)return a.lastIndexOf(b);for(var c=a.length;c--;)if(c in a&&a[c]===b)return c;return-1};d.range=function(a,b,c){1>=arguments.length&&(b=a||0,a=0);for(var c=arguments[2]||1,d=Math.max(Math.ceil((b-
a)/c),0),e=0,f=Array(d);e<d;)f[e++]=a,a+=c;return f};var L=function(){};d.bind=function(a,b){var c,e;if(a.bind===y&&y)return y.apply(a,h.call(arguments,1));if(!d.isFunction(a))throw new TypeError;e=h.call(arguments,2);return c=function(){if(!(this instanceof c))return a.apply(b,e.concat(h.call(arguments)));L.prototype=a.prototype;var d=new L,f=a.apply(d,e.concat(h.call(arguments)));return Object(f)===f?f:d}};d.bindAll=function(a){var b=h.call(arguments,1);0==b.length&&(b=d.functions(a));k(b,function(b){a[b]=
d.bind(a[b],a)});return a};d.memoize=function(a,b){var c={};b||(b=d.identity);return function(){var e=b.apply(this,arguments);return d.has(c,e)?c[e]:c[e]=a.apply(this,arguments)}};d.delay=function(a,b){var c=h.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)};d.defer=function(a){return d.delay.apply(d,[a,1].concat(h.call(arguments,1)))};d.throttle=function(a,b){var c,e,f,h,j,l,k=d.debounce(function(){j=h=!1},b);return function(){c=this;e=arguments;f||(f=setTimeout(function(){f=
null;j&&a.apply(c,e);k()},b));h?j=!0:l=a.apply(c,e);k();h=!0;return l}};d.debounce=function(a,b,c){var d;return function(){var e=this,f=arguments;c&&!d&&a.apply(e,f);clearTimeout(d);d=setTimeout(function(){d=null;c||a.apply(e,f)},b)}};d.once=function(a){var b=!1,c;return function(){if(b)return c;b=!0;return c=a.apply(this,arguments)}};d.wrap=function(a,b){return function(){var c=[a].concat(h.call(arguments,0));return b.apply(this,c)}};d.compose=function(){var a=arguments;return function(){for(var b=
arguments,c=a.length-1;0<=c;c--)b=[a[c].apply(this,b)];return b[0]}};d.after=function(a,b){return 0>=a?b():function(){if(1>--a)return b.apply(this,arguments)}};d.keys=M||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[],c;for(c in a)d.has(a,c)&&(b[b.length]=c);return b};d.values=function(a){return d.map(a,d.identity)};d.functions=d.methods=function(a){var b=[],c;for(c in a)d.isFunction(a[c])&&b.push(c);return b.sort()};d.extend=function(a){k(h.call(arguments,1),function(b){for(var c in b)a[c]=
b[c]});return a};d.pick=function(a){var b={};k(d.flatten(h.call(arguments,1)),function(c){c in a&&(b[c]=a[c])});return b};d.defaults=function(a){k(h.call(arguments,1),function(b){for(var c in b)null==a[c]&&(a[c]=b[c])});return a};d.clone=function(a){return!d.isObject(a)?a:d.isArray(a)?a.slice():d.extend({},a)};d.tap=function(a,b){b(a);return a};d.isEqual=function(a,b){return c(a,b,[])};d.isEmpty=function(a){if(null==a)return!0;if(d.isArray(a)||d.isString(a))return 0===a.length;for(var b in a)if(d.has(a,
b))return!1;return!0};d.isElement=function(a){return!!(a&&1==a.nodeType)};d.isArray=l||function(a){return"[object Array]"==m.call(a)};d.isObject=function(a){return a===Object(a)};d.isArguments=function(a){return"[object Arguments]"==m.call(a)};d.isArguments(arguments)||(d.isArguments=function(a){return!(!a||!d.has(a,"callee"))});d.isFunction=function(a){return"[object Function]"==m.call(a)};d.isString=function(a){return"[object String]"==m.call(a)};d.isNumber=function(a){return"[object Number]"==
m.call(a)};d.isFinite=function(a){return d.isNumber(a)&&isFinite(a)};d.isNaN=function(a){return a!==a};d.isBoolean=function(a){return!0===a||!1===a||"[object Boolean]"==m.call(a)};d.isDate=function(a){return"[object Date]"==m.call(a)};d.isRegExp=function(a){return"[object RegExp]"==m.call(a)};d.isNull=function(a){return null===a};d.isUndefined=function(a){return void 0===a};d.has=function(a,b){return t.call(a,b)};d.noConflict=function(){b._=e;return this};d.identity=function(a){return a};d.times=
function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)};d.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};d.result=function(a,b){if(null==a)return null;var c=a[b];return d.isFunction(c)?c.call(a):c};d.mixin=function(a){k(d.functions(a),function(b){var c=d[b]=a[b];r.prototype[b]=function(){var a=h.call(arguments);s.call(a,this._wrapped);return z(c.apply(d,a),this._chain)}})};var N=0;d.uniqueId=
function(a){var b=N++;return a?a+b:b};d.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var A=/.^/,u={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"},B;for(B in u)u[u[B]]=B;var O=/\\|'|\r|\n|\t|\u2028|\u2029/g,P=/\\(\\|'|r|n|t|u2028|u2029)/g,C=function(a){return a.replace(P,function(a,b){return u[b]})};d.template=function(a,b,c){c=d.defaults(c||{},d.templateSettings);a="__p+='"+a.replace(O,function(a){return"\\"+u[a]}).replace(c.escape||
A,function(a,b){return"'+\n_.escape("+C(b)+")+\n'"}).replace(c.interpolate||A,function(a,b){return"'+\n("+C(b)+")+\n'"}).replace(c.evaluate||A,function(a,b){return"';\n"+C(b)+"\n;__p+='"})+"';\n";c.variable||(a="with(obj||{}){\n"+a+"}\n");var a="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+a+"return __p;\n",e=new Function(c.variable||"obj","_",a);if(b)return e(b,d);b=function(a){return e.call(this,a,d)};b.source="function("+(c.variable||"obj")+"){\n"+a+"}";return b};
d.chain=function(a){return d(a).chain()};var r=function(a){this._wrapped=a};d.prototype=r.prototype;var z=function(a,b){return b?d(a).chain():a};d.mixin(d);k("pop push reverse shift sort splice unshift".split(" "),function(a){var b=j[a];r.prototype[a]=function(){var c=this._wrapped;b.apply(c,arguments);var d=c.length;("shift"==a||"splice"==a)&&0===d&&delete c[0];return z(c,this._chain)}});k(["concat","join","slice"],function(a){var b=j[a];r.prototype[a]=function(){return z(b.apply(this._wrapped,arguments),
this._chain)}});r.prototype.chain=function(){this._chain=!0;return this};r.prototype.value=function(){return this._wrapped}}).call(this);var MicroEvent=function(){};
MicroEvent.prototype={bind:function(c,b){this._events=this._events||{};this._events[c]=this._events[c]||[];this._events[c].push(b)},unbind:function(c,b){this._events=this._events||{};!1!==c in this._events&&this._events[c].splice(this._events[c].indexOf(b),1)},trigger:function(c){this._events=this._events||{};if(!1!==c in this._events)for(var b=0;b<this._events[c].length;b++)this._events[c][b].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(c){for(var b=["bind","unbind","trigger"],e=0;e<b.length;e++)c.prototype[b[e]]=MicroEvent.prototype[b[e]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);(function(c){for(var b in c)if(!window[b])throw"Error: ThreeRTT requires "+c[b];})({THREE:"Three.js"});window.ThreeRTT=window.ThreeRTT||{};ThreeRTT.getShader=function(c){var b=document.getElementById(c);return b&&b.innerText||c};_.loop=function(c,b){for(var e=0;e<c;++e)b(e)};
ThreeRTT.getShader=function(c){var b=document.getElementById(c);return b&&(b.innerText||b.textContent)||c};ThreeRTT.isPowerOfTwo=function(c){return 0===(c&c-1)};ThreeRTT.toTarget=function(c){return ThreeRTT.Stage&&c instanceof ThreeRTT.Stage?c.target:ThreeRTT.World&&c instanceof ThreeRTT.World?c.target():c};ThreeRTT.toTexture=function(c){c=ThreeRTT.toTarget(c);if(ThreeRTT.RenderTarget&&c instanceof ThreeRTT.RenderTarget)return c.read()};
MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};MicroEvent.mixin=function(c){for(var b=["bind","unbind","trigger","on","emit"],e=0;e<b.length;e++)c.prototype[b[e]]=MicroEvent.prototype[b[e]]};
ThreeRTT.Stage=function(c,b){b=_.extend({history:0,camera:{},material:!1,scene:null},b);b.camera.aspect=b.camera.aspect||b.width/b.height;this.scene=b.scene||new THREE.Scene;this.camera=ThreeRTT.Camera(b.camera);this.scene.add(this.camera);this.target=new ThreeRTT.RenderTarget(c,b);0<=b.history&&(b.material=b.material||new ThreeRTT.FragmentMaterial(this));b.material&&this.material(b.material)};
ThreeRTT.Stage.prototype={material:function(c){return void 0!==c?(c?(this._surface||(this._surface=new THREE.Mesh(new ThreeRTT.ScreenGeometry,{}),this._surface.frustumCulled=!1,this.scene.add(this._surface)),this._surface.material=c):(this.scene.remove(this._surface),this._surface=null),this):this._surface&&this._surface.material},size:function(c,b){this.camera.aspect=c/b;this.target.size(c,b);return this},read:function(c){return this.target.read(c)},uniform:function(){return this.target.uniform()},
render:function(){this.target.clear();this.target.render(this.scene,this.camera);return this},clear:function(){this.target.clear();return this},destroy:function(){this.target.deallocate();this.target=this.camera=this.scene=null}};ThreeRTT.Compose=function(c,b,e,f,j){b=new ThreeRTT.FragmentMaterial(b,e,f,j);e=new ThreeRTT.ScreenGeometry;b=new THREE.Mesh(e,b);b.frustumCulled=!1;c.add(b);this.scene=c;this.mesh=b};ThreeRTT.Compose.prototype.remove=function(){this.scene.remove(this.mesh)};
ThreeRTT.Camera=function(c){if(c.constructor instanceof THREE.Camera)return c;c=_.extend({aspect:1,far:1E4,fov:85,near:0.01,ortho:!1,scale:1},c);if(c.ortho){var b=c.scale,e=c.aspect;return new THREE.OrthographicCamera(-b*e,b*e,-b,b,c.near,c.far)}return new THREE.PerspectiveCamera(c.fov,c.aspect,c.near,c.far)};
ThreeRTT.RenderTarget=function(c,b){this.options=b=_.extend({width:256,height:256,texture:{},clear:{color:!1,depth:!0,stencil:!0},clearColor:16777215,clearAlpha:1,history:0,scene:null,camera:null,autoAdvance:!0},b);this.renderer=c;if((!ThreeRTT.isPowerOfTwo(b.width)||!ThreeRTT.isPowerOfTwo(b.height))&&!b.texture.minFilter)b.texture.minFilter=THREE.LinearFilter;this.history(this.options.history,!0);this.size(b.width,b.height);this.clear()};
ThreeRTT.RenderTarget.prototype={read:function(c){c=Math.max(0,Math.min(this.options.history,Math.abs(c||0)));return this.virtuals[c]},write:function(){return this.targets[this.index]},history:function(c,b){void 0!==c&&(this._history=c,this.buffers=c+2,b||this.allocate());return this._history},size:function(c,b){c&&b&&(this.width=Math.floor(c),this.height=Math.floor(b),this.allocate());return{width:this.width,height:this.height}},deallocate:function(){this.deallocateTargets()},allocate:function(){this.deallocateTargets();
this.allocateTargets();this.allocateVirtuals()},deallocateTargets:function(){_.each(this.targets||[],function(c){this.renderer.deallocateRenderTarget(c)}.bind(this))},allocateTargets:function(){var c=this.options;n=this.buffers;var b=this.targets=[];_.loop(n,function(e){b.push(new THREE.WebGLRenderTarget(this.width,this.height,c.texture));b[e].__index=e}.bind(this))},allocateVirtuals:function(){var c=this.targets[0],b=this.virtuals||[];n=Math.max(1,this.buffers-1);n>b.length?_.loop(n-b.length,function(){b.push(c.clone())}.bind(this)):
b=b.slice(0,n);_.each(b,function(b,c){b.width=this.width;b.height=this.height;b.__index=c}.bind(this));this.virtuals=b;this.index=-1;this.advance()},advance:function(){var c=this.targets,b=this.virtuals,e=this.index,f=this.buffers,j=b.length;this.index=e=(e+1)%f;_.loop(j,function(l){var h=b[l],l=c[(j-l+e)%f];h.__webglTexture=l.__webglTexture;h.__webglFramebuffer=l.__webglFramebuffer;h.__webglRenderbuffer=l.__webglRenderbuffer;h.__index=l.__index})},clear:function(){var c=this.options,b=c.clear,e=
this.renderer,f=e.getClearColor().clone(),j=e.getClearAlpha();e.setClearColorHex(c.clearColor,c.clearAlpha);e.clearTarget(this.write(),b.color,b.stencil,b.depth);e.setClearColor(f,j)},render:function(c,b){this.emit("render",c,b);var e=this.renderer.autoClear;this.renderer.autoClear=!1;this.clear();this.renderer.render(c,b,this.write());this.renderer.autoClear=e;this.options.autoAdvance&&this.advance()},uniform:function(c){var b=this.history();if(b){var e=[];_.loop(b+1,function(b){e.push(this.read(-b))}.bind(this));
return{type:"tv",value:c,texture:e,count:b+1}}return{type:"t",value:c,texture:this.read(),count:1}}};MicroEvent.mixin(ThreeRTT.RenderTarget);ThreeRTT.ScreenGeometry=function(){return new THREE.PlaneGeometry(2,2,1,1)};
ThreeRTT.FragmentMaterial=function(c,b,e,f){if(e instanceof Array){var j={};_.each(e,function(b){j["texture"+(i+1)]=b});e=j}else e&&(e={texture1:e});c instanceof Array||(c=[c]);c=_.map(c,function(b){return ThreeRTT.toTarget(b)});f=_.extend(f||{},{sampleStep:{type:"v2",value:new THREE.Vector2}});_.each(e,function(b,c){f[c]={type:"t",value:ThreeRTT.toTexture(b)}});_.each(c,function(b,c){var e="texture"+(c+1);f[e]||(f[e]={type:"t",value:b.read()})});f.texture1&&!f.texture&&(f.texture=f.texture1);c[0].on("render",
function(){var b=f.sampleStep.value;b.x=1/(c[0].width-1);b.y=1/(c[0].height-1)});b=new THREE.ShaderMaterial({uniforms:f,vertexShader:ThreeRTT.getShader("generic-vertex-screen"),fragmentShader:ThreeRTT.getShader(b||"generic-fragment-texture")});b.side=THREE.DoubleSide;return b};
ThreeRTT.DownsampleMaterial=function(c,b){var e={},c=ThreeRTT.toTarget(c),b=ThreeRTT.toTarget(b),e=_.extend(e,{sampleAlignment:{type:"v2",value:new THREE.Vector2},texture:{type:"t",value:0,texture:c.read()}});b.on("render",function(){var f=c,j=b,l=2*j.height/f.height,h=e.sampleAlignment.value;h.x=2*j.width/f.width;h.y=l});return new THREE.ShaderMaterial({uniforms:e,vertexShader:ThreeRTT.getShader("rtt-vertex-downsample"),fragmentShader:ThreeRTT.getShader("generic-fragment-texture")})};
ThreeRTT.RaytraceMaterial=function(c,b,e,f){e instanceof Array?_.each(e,function(){}):e.constructor!=Object&&(e={texture1:e});var c=ThreeRTT.toTarget(c),f=_.extend(f||{},{cameraViewport:{type:"v2",value:new THREE.Vector2},cameraWorld:{type:"m4",value:new THREE.Matrix4}}),j=0;_.each(e||[],function(b,c){f[c]={type:"t",value:j++,texture:ThreeRTT.toTexture(b)}});c.on("render",function(b,c){c.updateMatrixWorld();if(c.fov){var e=Math.tan(c.fov*\u03c0/360);f.cameraViewport.value.set(e*c.aspect,e)}c.matrixWorld&&
(f.cameraWorld.value=c.matrixWorld)});return new THREE.ShaderMaterial({uniforms:f,vertexShader:ThreeRTT.getShader("generic-vertex-screen"),fragmentShader:ThreeRTT.getShader(b)})};ThreeRTT.Display=function(c,b,e){e instanceof Array||(e=[e]);this.gx=c;this.gy=b;this.targets=e;this.n=e.length;THREE.Object3D.call(this);this.make()};
ThreeRTT.Display.prototype=_.extend(new THREE.Object3D,{make:function(){for(var c=this.n,b=this.gx,e=this.gy,f=this.targets,j=(b-1)/2,l=(e-1)/2,h=new THREE.PlaneGeometry(1,1,1,1),s=0,m=0;s<c&&m<e;++m)for(var t=0;s<c&&t<b;++t,++s){var q=new THREE.MeshBasicMaterial({color:16777215,map:f[s].read(),fog:!1});q.side=THREE.DoubleSide;q=new THREE.Mesh(h,q);this.add(q);1<b&&(q.position.x=-j+t);1<e&&(q.position.y=l-m)}}});
ThreeRTT.World=function(c,b){b=b||{};b=_.extend({autoRendering:!0,autoSize:!(b.width&&b.height),order:++ThreeRTT.World.sequence,scale:1},b);b.width=!b.autoSize&&b.width||(c._opts&&c._opts.renderW||256)/b.scale;b.height=!b.autoSize&&b.height||(c._opts&&c._opts.renderH||256)/b.scale;c.on("resize",function(c,f){b.autoSize&&(c/=b.scale,f/=b.scale,this.size(c,f))}.bind(this));this._options=b;this._world=c;this._autoRendering=b.autoRendering;this._renderer=c.tRenderer();this._stage=new ThreeRTT.Stage(this._renderer,
b);this._scene=this._stage.scene;this._camera=this._stage.camera;this.queue=ThreeRTT.RenderQueue.bind(c);b.autoRendering&&this.queue.add(this);this.size(b.width,b.height,!0)};ThreeRTT.World.sequence=1E5;
ThreeRTT.World.prototype=_.extend(new THREE.Object3D,tQuery.World.prototype,{stage:function(){return this._stage},target:function(){return this._stage.target},autoSize:function(c){void 0!==c&&(this._options.autoSize=c);return this._options.autoSize},scale:function(c){if(c){this._options.scale=c;if(this._options.autoSize){var b=this._world._opts;this.size(b.renderW/c,b.renderH/c)}return this}return this._options.scale},size:function(c,b,e){return c&&b?(this._options.width=c,this._options.height=b,
this._opts={renderW:c,renderH:b},e||this._stage.size(c,b),this):{width:this._options.width,height:this._options.height}},material:function(c){return this._stage.material(c)},read:function(c){return this._stage.read(c)},uniform:function(){return this._stage.uniform()},render:function(){this._stage.render();return this},destroy:function(){this._stage.destroy();this._stage=null;this.queue.remove(this);this.trigger("destroy");return this}});tQuery.pluginsInstanceOn(ThreeRTT.World);tQuery.MicroeventMixin(ThreeRTT.World.prototype);
ThreeRTT.RenderQueue=function(c){this.world=c;this.queue=[];this.callback=null;this.renderer=c.tRenderer()};
ThreeRTT.RenderQueue.prototype={add:function(c){this.queue.push(c);this.sort();this.init()},remove:function(c){this.queue.splice(this.queue.indexOf(c),1);this.cleanup()},init:function(){var c=this.queue,b=this.world;c.length&&!this.callback&&b.loop().hookPreRender(this.callback=function(){_.each(c,function(b){b.render()})})},cleanup:function(){var c=this.world;!this.queue.length&&this.callback&&(c.loop().unhookPreRender(this.callback),this.callback=null)},sort:function(){this.queue.sort(function(c,
b){return c.order-b.order})}};ThreeRTT.RenderQueue.bind=function(c){return c.__rttRenderQueue?c.__rttRenderQueue:c.__rttRenderQueue=new ThreeRTT.RenderQueue(c)};tQuery.World.registerInstance("rtt",function(c){return tQuery.createRTT(this,c)});tQuery.World.registerInstance("compose",function(c,b,e,f){tQuery.composeRTT(this,c,b,e,f);return this});ThreeRTT.World.registerInstance("fragment",function(c,b,e){this.material(tQuery.createFragmentMaterial(this,c,b,e));return this});
ThreeRTT.World.registerInstance("raytrace",function(c,b,e){this.material(tQuery.createRaytraceMaterial(this,c,b,e));return this});ThreeRTT.World.registerInstance("downsample",function(c){var b=c.scale();this.scale(2*b);c.autoSize||(b=c.size(),this.size(b.width/2,b.height/2));this.material(tQuery.createDownsampleMaterial(c,this));return this});tQuery.registerStatic("createRTT",function(c,b){return new ThreeRTT.World(c,b)});
tQuery.registerStatic("composeRTT",function(c,b,e,f,j){return new ThreeRTT.Compose(c.tScene(),b,e,f,j)});tQuery.registerStatic("createFragmentMaterial",function(c,b,e,f){return new ThreeRTT.FragmentMaterial(c,b,e,f)});tQuery.registerStatic("createRaytraceMaterial",function(c,b,e,f){return new ThreeRTT.RaytraceMaterial(c,b,e,f)});tQuery.registerStatic("createDownsampleMaterial",function(c,b){return new ThreeRTT.DownsampleMaterial(c,b)});
