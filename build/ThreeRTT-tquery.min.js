(function(){function a(c,k,b){if(c===k)return 0!==c||1/c==1/k;if(null==c||null==k)return c===k;c._chain&&(c=c._wrapped);k._chain&&(k=k._wrapped);if(c.isEqual&&d.isFunction(c.isEqual))return c.isEqual(k);if(k.isEqual&&d.isFunction(k.isEqual))return k.isEqual(c);var w=m.call(c);if(w!=m.call(k))return!1;switch(w){case "[object String]":return c==""+k;case "[object Number]":return c!=+c?k!=+k:0==c?1/c==1/k:c==+k;case "[object Date]":case "[object Boolean]":return+c==+k;case "[object RegExp]":return c.source==
k.source&&c.global==k.global&&c.multiline==k.multiline&&c.ignoreCase==k.ignoreCase}if("object"!=typeof c||"object"!=typeof k)return!1;for(var e=b.length;e--;)if(b[e]==c)return!0;b.push(c);var e=0,f=!0;if("[object Array]"==w){if(e=c.length,f=e==k.length)for(;e--&&(f=e in c==e in k&&a(c[e],k[e],b)););}else{if("constructor"in c!="constructor"in k||c.constructor!=k.constructor)return!1;for(var g in c)if(d.has(c,g)&&(e++,!(f=d.has(k,g)&&a(c[g],k[g],b))))break;if(f){for(g in k)if(d.has(k,g)&&!e--)break;
f=!e}}b.pop();return f}var b=this,e=b._,f={},h=Array.prototype,l=Object.prototype,g=h.slice,r=h.unshift,m=l.toString,t=l.hasOwnProperty,q=h.forEach,C=h.map,D=h.reduce,E=h.reduceRight,F=h.filter,G=h.every,H=h.some,v=h.indexOf,I=h.lastIndexOf,l=Array.isArray,N=Object.keys,x=Function.prototype.bind,d=function(c){return new s(c)};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=d),exports._=d):b._=d;d.VERSION="1.3.3";var p=d.each=d.forEach=function(c,
a,b){if(null!=c)if(q&&c.forEach===q)c.forEach(a,b);else if(c.length===+c.length)for(var e=0,M=c.length;e<M&&!(e in c&&a.call(b,c[e],e,c)===f);e++);else for(e in c)if(d.has(c,e)&&a.call(b,c[e],e,c)===f)break};d.map=d.collect=function(c,a,b){var d=[];if(null==c)return d;if(C&&c.map===C)return c.map(a,b);p(c,function(c,e,f){d[d.length]=a.call(b,c,e,f)});c.length===+c.length&&(d.length=c.length);return d};d.reduce=d.foldl=d.inject=function(c,a,b,e){var f=2<arguments.length;null==c&&(c=[]);if(D&&c.reduce===
D)return e&&(a=d.bind(a,e)),f?c.reduce(a,b):c.reduce(a);p(c,function(c,d,g){f?b=a.call(e,b,c,d,g):(b=c,f=!0)});if(!f)throw new TypeError("Reduce of empty array with no initial value");return b};d.reduceRight=d.foldr=function(c,a,b,e){var f=2<arguments.length;null==c&&(c=[]);if(E&&c.reduceRight===E)return e&&(a=d.bind(a,e)),f?c.reduceRight(a,b):c.reduceRight(a);var g=d.toArray(c).reverse();e&&!f&&(a=d.bind(a,e));return f?d.reduce(g,a,b,e):d.reduce(g,a)};d.find=d.detect=function(c,a,b){var d;J(c,function(c,
e,f){if(a.call(b,c,e,f))return d=c,!0});return d};d.filter=d.select=function(c,a,b){var d=[];if(null==c)return d;if(F&&c.filter===F)return c.filter(a,b);p(c,function(c,e,f){a.call(b,c,e,f)&&(d[d.length]=c)});return d};d.reject=function(c,a,b){var d=[];if(null==c)return d;p(c,function(c,e,f){a.call(b,c,e,f)||(d[d.length]=c)});return d};d.every=d.all=function(c,a,b){var d=!0;if(null==c)return d;if(G&&c.every===G)return c.every(a,b);p(c,function(c,e,g){if(!(d=d&&a.call(b,c,e,g)))return f});return!!d};
var J=d.some=d.any=function(c,a,b){a||(a=d.identity);var e=!1;if(null==c)return e;if(H&&c.some===H)return c.some(a,b);p(c,function(c,d,g){if(e||(e=a.call(b,c,d,g)))return f});return!!e};d.include=d.contains=function(c,a){var b=!1;return null==c?b:v&&c.indexOf===v?-1!=c.indexOf(a):b=J(c,function(c){return c===a})};d.invoke=function(c,a){var b=g.call(arguments,2);return d.map(c,function(c){return(d.isFunction(a)?a||c:c[a]).apply(c,b)})};d.pluck=function(c,a){return d.map(c,function(c){return c[a]})};
d.max=function(c,a,b){if(!a&&d.isArray(c)&&c[0]===+c[0])return Math.max.apply(Math,c);if(!a&&d.isEmpty(c))return-Infinity;var e={computed:-Infinity};p(c,function(c,d,f){d=a?a.call(b,c,d,f):c;d>=e.computed&&(e={value:c,computed:d})});return e.value};d.min=function(c,a,b){if(!a&&d.isArray(c)&&c[0]===+c[0])return Math.min.apply(Math,c);if(!a&&d.isEmpty(c))return Infinity;var e={computed:Infinity};p(c,function(c,d,f){d=a?a.call(b,c,d,f):c;d<e.computed&&(e={value:c,computed:d})});return e.value};d.shuffle=
function(c){var a=[],b;p(c,function(c,d){b=Math.floor(Math.random()*(d+1));a[d]=a[b];a[b]=c});return a};d.sortBy=function(c,a,b){var e=d.isFunction(a)?a:function(c){return c[a]};return d.pluck(d.map(c,function(c,a,d){return{value:c,criteria:e.call(b,c,a,d)}}).sort(function(c,a){var b=c.criteria,d=a.criteria;return void 0===b?1:void 0===d?-1:b<d?-1:b>d?1:0}),"value")};d.groupBy=function(c,a){var b={},e=d.isFunction(a)?a:function(c){return c[a]};p(c,function(c,a){var d=e(c,a);(b[d]||(b[d]=[])).push(c)});
return b};d.sortedIndex=function(c,a,b){b||(b=d.identity);for(var e=0,f=c.length;e<f;){var g=e+f>>1;b(c[g])<b(a)?e=g+1:f=g}return e};d.toArray=function(c){return c?d.isArray(c)||d.isArguments(c)?g.call(c):c.toArray&&d.isFunction(c.toArray)?c.toArray():d.values(c):[]};d.size=function(c){return d.isArray(c)?c.length:d.keys(c).length};d.first=d.head=d.take=function(c,a,b){return null==a||b?c[0]:g.call(c,0,a)};d.initial=function(c,a,b){return g.call(c,0,c.length-(null==a||b?1:a))};d.last=function(c,a,
b){return null==a||b?c[c.length-1]:g.call(c,Math.max(c.length-a,0))};d.rest=d.tail=function(c,a,b){return g.call(c,null==a||b?1:a)};d.compact=function(c){return d.filter(c,function(c){return!!c})};d.flatten=function(c,a){return d.reduce(c,function(c,b){if(d.isArray(b))return c.concat(a?b:d.flatten(b));c[c.length]=b;return c},[])};d.without=function(c){return d.difference(c,g.call(arguments,1))};d.uniq=d.unique=function(c,a,b){b=b?d.map(c,b):c;var e=[];3>c.length&&(a=!0);d.reduce(b,function(b,f,L){(a?
d.last(b)===f&&b.length:d.include(b,f))||(b.push(f),e.push(c[L]));return b},[]);return e};d.union=function(){return d.uniq(d.flatten(arguments,!0))};d.intersection=d.intersect=function(c){var a=g.call(arguments,1);return d.filter(d.uniq(c),function(c){return d.every(a,function(a){return 0<=d.indexOf(a,c)})})};d.difference=function(c){var a=d.flatten(g.call(arguments,1),!0);return d.filter(c,function(c){return!d.include(a,c)})};d.zip=function(){for(var c=g.call(arguments),a=d.max(d.pluck(c,"length")),
b=Array(a),e=0;e<a;e++)b[e]=d.pluck(c,""+e);return b};d.indexOf=function(c,a,b){if(null==c)return-1;var e;if(b)return b=d.sortedIndex(c,a),c[b]===a?b:-1;if(v&&c.indexOf===v)return c.indexOf(a);b=0;for(e=c.length;b<e;b++)if(b in c&&c[b]===a)return b;return-1};d.lastIndexOf=function(c,a){if(null==c)return-1;if(I&&c.lastIndexOf===I)return c.lastIndexOf(a);for(var b=c.length;b--;)if(b in c&&c[b]===a)return b;return-1};d.range=function(c,a,b){1>=arguments.length&&(a=c||0,c=0);b=arguments[2]||1;for(var d=
Math.max(Math.ceil((a-c)/b),0),e=0,f=Array(d);e<d;)f[e++]=c,c+=b;return f};var K=function(){};d.bind=function(c,a){var b,e;if(c.bind===x&&x)return x.apply(c,g.call(arguments,1));if(!d.isFunction(c))throw new TypeError;e=g.call(arguments,2);return b=function(){if(!(this instanceof b))return c.apply(a,e.concat(g.call(arguments)));K.prototype=c.prototype;var d=new K,f=c.apply(d,e.concat(g.call(arguments)));return Object(f)===f?f:d}};d.bindAll=function(c){var a=g.call(arguments,1);0==a.length&&(a=d.functions(c));
p(a,function(a){c[a]=d.bind(c[a],c)});return c};d.memoize=function(c,a){var b={};a||(a=d.identity);return function(){var e=a.apply(this,arguments);return d.has(b,e)?b[e]:b[e]=c.apply(this,arguments)}};d.delay=function(c,a){var b=g.call(arguments,2);return setTimeout(function(){return c.apply(null,b)},a)};d.defer=function(c){return d.delay.apply(d,[c,1].concat(g.call(arguments,1)))};d.throttle=function(c,a){var b,e,f,g,h,l,m=d.debounce(function(){h=g=!1},a);return function(){b=this;e=arguments;f||
(f=setTimeout(function(){f=null;h&&c.apply(b,e);m()},a));g?h=!0:l=c.apply(b,e);m();g=!0;return l}};d.debounce=function(c,a,b){var d;return function(){var e=this,f=arguments;b&&!d&&c.apply(e,f);clearTimeout(d);d=setTimeout(function(){d=null;b||c.apply(e,f)},a)}};d.once=function(c){var a=!1,b;return function(){if(a)return b;a=!0;return b=c.apply(this,arguments)}};d.wrap=function(c,a){return function(){var b=[c].concat(g.call(arguments,0));return a.apply(this,b)}};d.compose=function(){var a=arguments;
return function(){for(var b=arguments,d=a.length-1;0<=d;d--)b=[a[d].apply(this,b)];return b[0]}};d.after=function(a,b){return 0>=a?b():function(){if(1>--a)return b.apply(this,arguments)}};d.keys=N||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[],e;for(e in a)d.has(a,e)&&(b[b.length]=e);return b};d.values=function(a){return d.map(a,d.identity)};d.functions=d.methods=function(a){var b=[],e;for(e in a)d.isFunction(a[e])&&b.push(e);return b.sort()};d.extend=function(a){p(g.call(arguments,
1),function(b){for(var d in b)a[d]=b[d]});return a};d.pick=function(a){var b={};p(d.flatten(g.call(arguments,1)),function(d){d in a&&(b[d]=a[d])});return b};d.defaults=function(a){p(g.call(arguments,1),function(b){for(var d in b)null==a[d]&&(a[d]=b[d])});return a};d.clone=function(a){return d.isObject(a)?d.isArray(a)?a.slice():d.extend({},a):a};d.tap=function(a,b){b(a);return a};d.isEqual=function(c,b){return a(c,b,[])};d.isEmpty=function(a){if(null==a)return!0;if(d.isArray(a)||d.isString(a))return 0===
a.length;for(var b in a)if(d.has(a,b))return!1;return!0};d.isElement=function(a){return!(!a||1!=a.nodeType)};d.isArray=l||function(a){return"[object Array]"==m.call(a)};d.isObject=function(a){return a===Object(a)};d.isArguments=function(a){return"[object Arguments]"==m.call(a)};d.isArguments(arguments)||(d.isArguments=function(a){return!(!a||!d.has(a,"callee"))});d.isFunction=function(a){return"[object Function]"==m.call(a)};d.isString=function(a){return"[object String]"==m.call(a)};d.isNumber=function(a){return"[object Number]"==
m.call(a)};d.isFinite=function(a){return d.isNumber(a)&&isFinite(a)};d.isNaN=function(a){return a!==a};d.isBoolean=function(a){return!0===a||!1===a||"[object Boolean]"==m.call(a)};d.isDate=function(a){return"[object Date]"==m.call(a)};d.isRegExp=function(a){return"[object RegExp]"==m.call(a)};d.isNull=function(a){return null===a};d.isUndefined=function(a){return void 0===a};d.has=function(a,b){return t.call(a,b)};d.noConflict=function(){b._=e;return this};d.identity=function(a){return a};d.times=
function(a,b,d){for(var e=0;e<a;e++)b.call(d,e)};d.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};d.result=function(a,b){if(null==a)return null;var e=a[b];return d.isFunction(e)?e.call(a):e};d.mixin=function(a){p(d.functions(a),function(b){O(b,d[b]=a[b])})};var P=0;d.uniqueId=function(a){var b=P++;return a?a+b:b};d.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,
escape:/<%-([\s\S]+?)%>/g};var y=/.^/,u={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"},z;for(z in u)u[u[z]]=z;var Q=/\\|'|\r|\n|\t|\u2028|\u2029/g,R=/\\(\\|'|r|n|t|u2028|u2029)/g,A=function(a){return a.replace(R,function(a,b){return u[b]})};d.template=function(a,b,e){e=d.defaults(e||{},d.templateSettings);a="__p+='"+a.replace(Q,function(a){return"\\"+u[a]}).replace(e.escape||y,function(a,b){return"'+\n_.escape("+A(b)+")+\n'"}).replace(e.interpolate||y,function(a,b){return"'+\n("+
A(b)+")+\n'"}).replace(e.evaluate||y,function(a,b){return"';\n"+A(b)+"\n;__p+='"})+"';\n";e.variable||(a="with(obj||{}){\n"+a+"}\n");a="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+a+"return __p;\n";var f=new Function(e.variable||"obj","_",a);if(b)return f(b,d);b=function(a){return f.call(this,a,d)};b.source="function("+(e.variable||"obj")+"){\n"+a+"}";return b};d.chain=function(a){return d(a).chain()};var s=function(a){this._wrapped=a};d.prototype=s.prototype;
var B=function(a,b){return b?d(a).chain():a},O=function(a,b){s.prototype[a]=function(){var a=g.call(arguments);r.call(a,this._wrapped);return B(b.apply(d,a),this._chain)}};d.mixin(d);p("pop push reverse shift sort splice unshift".split(" "),function(a){var b=h[a];s.prototype[a]=function(){var d=this._wrapped;b.apply(d,arguments);var e=d.length;"shift"!=a&&"splice"!=a||0!==e||delete d[0];return B(d,this._chain)}});p(["concat","join","slice"],function(a){var b=h[a];s.prototype[a]=function(){return B(b.apply(this._wrapped,
arguments),this._chain)}});s.prototype.chain=function(){this._chain=!0;return this};s.prototype.value=function(){return this._wrapped}}).call(this);var MicroEvent=function(){};
MicroEvent.prototype={bind:function(a,b){this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(b)},unbind:function(a,b){this._events=this._events||{};!1!==a in this._events&&this._events[a].splice(this._events[a].indexOf(b),1)},trigger:function(a){this._events=this._events||{};if(!1!==a in this._events)for(var b=0;b<this._events[a].length;b++)this._events[a][b].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger"],e=0;e<b.length;e++)a.prototype[b[e]]=MicroEvent.prototype[b[e]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);(function(a){for(var b in a)if(!window[b])throw"Error: ThreeRTT requires "+a[b];})({THREE:"Three.js"});window.ThreeRTT=window.ThreeRTT||{};ThreeRTT.getShader=function(a){var b=document.getElementById(a);return b&&b.innerText||a};_.loop=function(a,b){for(var e=0;e<a;++e)b(e)};
ThreeRTT.getShader=function(a){var b=document.getElementById(a);return b&&(b.innerText||b.textContent)||a};ThreeRTT.isPowerOfTwo=function(a){return 0===(a&a-1)};ThreeRTT.toTarget=function(a){return ThreeRTT.Stage&&a instanceof ThreeRTT.Stage?a.target:ThreeRTT.World&&a instanceof ThreeRTT.World?a.target():a};ThreeRTT.toTexture=function(a,b){a=ThreeRTT.toTarget(a);return ThreeRTT.RenderTarget&&a instanceof ThreeRTT.RenderTarget?a.read():a};
MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger","on","emit"],e=0;e<b.length;e++)a.prototype[b[e]]=MicroEvent.prototype[b[e]]};
ThreeRTT.Stage=function(a,b){b=_.extend({history:0,camera:{},scene:null},b);b.camera.aspect=b.camera.aspect||b.width/b.height;this.scene=b.scene||new THREE.Scene;this.camera=ThreeRTT.Camera(b.camera);this.scene.add(this.camera);this.target=new ThreeRTT.RenderTarget(a,b);this.reset();this.size(b.width,b.height)};
ThreeRTT.Stage.prototype={options:function(){return this.target.options},reset:function(){this.renderables&&_.each(this.renderables,function(a){this.scene.remove(a)}.bind(this));this.passes=[];this.renderables=[]},paint:function(a,b){var e=new THREE.Object3D;e.frustumCulled=!1;e.visible=!0;if(!b){var f=new ThreeRTT.FragmentMaterial(this,"generic-fragment-texture"),f=this._surface(f);e.add(f)}e.add(a);this.scene.add(e);this.passes.push(1);this.renderables.push(e)},iterate:function(a,b){var e=this._surface(b);
e.visible=!1;this.scene.add(e);this.passes.push(a);this.renderables.push(e);return this},fragment:function(a){this.iterate(1,a);return this},size:function(a,b){a=Math.floor(a);b=Math.floor(b);this.camera.aspect=a/b;this.target.size(a,b);return this},read:function(a){return this.target.read(a)},uniform:function(){return this.target.uniform()},render:function(){function a(b,e){b.visible=e;_.each(b.children,function(b){a(b,e)})}this.target.clear();_.each(this.passes,function(b,e){a(this.renderables[e],
!0);_.loop(b,function(a){this.target.render(this.scene,this.camera)}.bind(this));a(this.renderables[e],!1)}.bind(this));return this},clear:function(){this.target.clear();return this},destroy:function(){this.target.deallocate();this.target=this.camera=this.scene=null},_surface:function(a){var b=new THREE.Mesh(new ThreeRTT.ScreenGeometry,{});b.frustumCulled=!1;b.material=a;b.renderDepth=Infinity;return b}};
ThreeRTT.Compose=function(a,b,e,f){THREE.Object3D.call(this);a=new ThreeRTT.FragmentMaterial(a,b,e,f);b=new ThreeRTT.ScreenGeometry;a=this.mesh=new THREE.Mesh(b,a);a.frustumCulled=!1;this.add(a)};ThreeRTT.Compose.prototype=new THREE.Object3D;
ThreeRTT.Camera=function(a){if(a.constructor instanceof THREE.Camera)return a;a=_.extend({aspect:1,far:1E4,fov:85,near:0.01,ortho:!1,scale:1},a);if(a.ortho){var b=a.scale,e=a.aspect;return new THREE.OrthographicCamera(-b*e,b*e,-b,b,a.near,a.far)}return new THREE.PerspectiveCamera(a.fov,a.aspect,a.near,a.far)};
ThreeRTT.RenderTarget=function(a,b){this.options=b=_.extend({width:256,height:256,texture:{},clear:{color:!1,depth:!1,stencil:!1},clearColor:16777215,clearAlpha:1,history:0,scene:null,camera:null,autoAdvance:!0},b);this.renderer=a;ThreeRTT.isPowerOfTwo(b.width)&&ThreeRTT.isPowerOfTwo(b.height)||b.texture.minFilter||(b.texture.minFilter=THREE.LinearFilter);this.history(this.options.history,!0);this.size(b.width,b.height);this.clear()};
ThreeRTT.RenderTarget.prototype={read:function(a){a=Math.max(0,Math.min(this.options.history,Math.abs(a||0)));return this.virtuals[a]},write:function(){return this.targets[this.index]},history:function(a,b){void 0!==a&&(this._history=a,this.buffers=a+2,b||this.allocate());return this._history},size:function(a,b){a&&b&&(this.width=Math.floor(a),this.height=Math.floor(b),this.allocate());return{width:this.width,height:this.height}},deallocate:function(){this.deallocateTargets()},allocate:function(){this.deallocateTargets();
this.allocateTargets();this.allocateVirtuals()},deallocateTargets:function(){_.each(this.targets||[],function(a){a.dispose()}.bind(this))},allocateTargets:function(){var a=this.options;n=this.buffers;var b=this.targets=[];_.loop(n,function(e){b.push(new THREE.WebGLRenderTarget(this.width,this.height,a.texture));b[e].__index=e}.bind(this))},allocateVirtuals:function(){var a=this.targets[0],b=this.virtuals||[];n=Math.max(1,this.buffers-1);n>b.length?_.loop(n-b.length,function(){b.push(a.clone())}.bind(this)):
b=b.slice(0,n);_.each(b,function(a,b){a.width=this.width;a.height=this.height;a.__index=b}.bind(this));this.virtuals=b;this.index=-1;this.advance()},advance:function(){var a=this.targets,b=this.virtuals,e=this.index,f=this.buffers,h=b.length;this.index=e=(e+1)%f;_.loop(h,function(l){var g=b[l];l=a[(h-l+e)%f];g.__webglTexture=l.__webglTexture;g.__webglFramebuffer=l.__webglFramebuffer;g.__webglRenderbuffer=l.__webglRenderbuffer;g.__index=l.__index})},clear:function(){var a=this.options,b=a.clear,e=
this.renderer,f=e.getClearColor().clone(),h=e.getClearAlpha();e.setClearColor(a.clearColor,a.clearAlpha);e.clearTarget(this.write(),b.color,b.stencil,b.depth);e.setClearColor(f,h)},render:function(a,b){this.emit("render",a,b);var e=this.renderer.autoClear;this.renderer.autoClear=!1;this.clear();this.renderer.render(a,b,this.write());this.renderer.autoClear=e;this.options.autoAdvance&&this.advance()},uniform:function(a){var b=this.history();if(b){var e=[];_.loop(b+1,function(a){e.push(this.read(-a))}.bind(this));
return{type:"tv",value:e,count:b+1}}return{type:"t",value:a,texture:this.read(),count:1}}};MicroEvent.mixin(ThreeRTT.RenderTarget);ThreeRTT.ScreenGeometry=function(){return new THREE.PlaneGeometry(2,2,1,1)};
ThreeRTT.ShaderMaterial=function(a,b,e,f,h){if(f instanceof Array){var l={};_.each(f,function(a,b){l["texture"+(i+1)]=a});f=l}else if(f instanceof THREE.Texture||f instanceof ThreeRTT.World||f instanceof THREE.WebGLRenderTarget)f={texture1:f};a instanceof Array||(a=[a]);a=_.map(a,function(a){return ThreeRTT.toTarget(a)});h=_.extend(h||{},{sampleStep:{type:"v2",value:new THREE.Vector2}});_.each(f,function(a,b){h[b]={type:"t",value:ThreeRTT.toTexture(a)}});_.each(a,function(a,b){var e="texture"+(b+
1);a.read&&!h[e]&&(h[e]={type:"t",value:a.read()})});h.texture1&&!h.texture&&(h.texture=h.texture1);a[0].on("render",function(){var b=a[0].options.texture,e=b.wrapT,f={1E3:0,1001:1,1002:0},l=h.sampleStep.value;l.x=1/(a[0].width-(f[b.wrapS]||0));l.y=1/(a[0].height-(f[e]||0))});return new THREE.ShaderMaterial({uniforms:h,vertexShader:ThreeRTT.getShader(b||"generic-vertex"),fragmentShader:ThreeRTT.getShader(e||"generic-fragment-texture")})};
ThreeRTT.FragmentMaterial=function(a,b,e,f){a=new ThreeRTT.ShaderMaterial(a,"generic-vertex-screen",b,e,f);a.side=THREE.DoubleSide;a.depthTest=!1;a.depthWrite=!1;a.transparent=!0;a.blending=THREE.NoBlending;return a};
ThreeRTT.ScaleMaterial=function(a,b,e){var f={};a=ThreeRTT.toTarget(a);b=ThreeRTT.toTarget(b);f=_.extend(f,{sampleAlignment:{type:"v2",value:new THREE.Vector2},texture:{type:"t",value:a.read()}});b.on("render",function(){var h=a,g=b,r=g.height*e/h.height,m=f.sampleAlignment.value;m.x=g.width*e/h.width;m.y=r});var h=new THREE.ShaderMaterial({uniforms:f,vertexShader:ThreeRTT.getShader("rtt-vertex-downsample"),fragmentShader:ThreeRTT.getShader("generic-fragment-texture")});h.side=THREE.DoubleSide;h.depthTest=
!1;h.depthWrite=!1;h.transparent=!0;h.blending=THREE.NoBlending;return h};ThreeRTT.DownsampleMaterial=function(a,b){return new ThreeRTT.ScaleMaterial(a,b,2)};ThreeRTT.UpsampleMaterial=function(a,b){return new ThreeRTT.ScaleMaterial(a,b,0.5)};
ThreeRTT.RaytraceMaterial=function(a,b,e,f){if(e instanceof Array)_.each(e,function(a,b){});else if(e instanceof THREE.Texture||e instanceof ThreeRTT.World||e instanceof THREE.WebGLRenderTarget)e={texture1:e};a=ThreeRTT.toTarget(a);f=_.extend(f||{},{cameraViewport:{type:"v2",value:new THREE.Vector2},cameraWorld:{type:"m4",value:new THREE.Matrix4}});var h=0;_.each(e||[],function(a,b){f[b]={type:"t",value:h++,texture:ThreeRTT.toTexture(a)}});a.on("render",function(a,b){b.updateMatrixWorld();if(b.fov){var e=
Math.tan(b.fov*\u03c0/360);f.cameraViewport.value.set(e*b.aspect,e)}b.matrixWorld&&(f.cameraWorld.value=b.matrixWorld)});return new THREE.ShaderMaterial({uniforms:f,vertexShader:ThreeRTT.getShader("generic-vertex-screen"),fragmentShader:ThreeRTT.getShader(b)})};ThreeRTT.Display=function(a,b,e){a instanceof Array||(a=[a]);this.gx=b||a.length;this.gy=e||1;this.targets=a;this.n=a.length;THREE.Object3D.call(this);this.make()};
ThreeRTT.Display.prototype=_.extend(new THREE.Object3D,{make:function(){for(var a=this.n,b=this.gx,e=this.gy,f=this.targets,h=(b-1)/2,l=(e-1)/2,g=new THREE.PlaneGeometry(1,1,1,1),r=0,m=0;r<a&&m<e;++m)for(var t=0;r<a&&t<b;++t,++r){var q=new THREE.MeshBasicMaterial({color:16777215,map:ThreeRTT.toTexture(f[r]),fog:!1});q.side=THREE.DoubleSide;q=new THREE.Mesh(g,q);q.renderDepth=1E4+Math.random();this.add(q);1<b&&(q.position.x=-h+t);1<e&&(q.position.y=l-m)}}});
ThreeRTT.World=function(a,b){b=b||{};b=_.extend({autoRendering:!0,autoSize:!(b.width&&b.height),order:++ThreeRTT.World.sequence,scale:1},b);b.width=!b.autoSize&&b.width||(a._opts&&a._opts.renderW||256)/b.scale;b.height=!b.autoSize&&b.height||(a._opts&&a._opts.renderH||256)/b.scale;a.on("resize",function(a,f){b.autoSize&&(a/=b.scale,f/=b.scale,this.size(a,f))}.bind(this));this._options=b;this._world=a;this._autoRendering=b.autoRendering;this._renderer=a.tRenderer();this._stage=new ThreeRTT.Stage(this._renderer,
b);this._tScene=this._stage.scene;this._tCamera=this._stage.camera;this.queue=ThreeRTT.RenderQueue.bind(a);b.autoRendering&&this.queue.add(this);this.size(b.width,b.height,!0)};ThreeRTT.World.sequence=1E5;
ThreeRTT.World.prototype=_.extend(new THREE.Object3D,tQuery.World.prototype,{stage:function(){return this._stage},target:function(){return this._stage.target},autoSize:function(a){void 0!==a&&(this._options.autoSize=a);return this._options.autoSize},adjust:function(a){var b=this._options.scale,e=this._options.width,f=this._options.height;this._options.autoSize&&(f=this._world._opts,e=f.renderW,f=f.renderH);e/=b;f/=b;this._opts={renderW:e,renderH:f};a||this._stage.size(e,f)},scale:function(a){return a?
(this._options.scale=a,this.adjust(),this):this._options.scale},size:function(a,b,e){return a&&b?(this._options.width=a,this._options.height=b,this.adjust(e),this):{width:this._options.width,height:this._options.height}},options:function(){return this._stage.options()},reset:function(){this._stage.reset();return this},paint:function(a,b){this._stage.paint(a,b);return this},iterate:function(a,b,e,f){b=b instanceof THREE.Material?b:tQuery.createFragmentMaterial(this,b,e,f);this._stage.iterate(a,b);
return this},shader:function(a,b,e,f){a=a instanceof THREE.Material?a:tQuery.createShaderMaterial(this,a,b,e,f);this._stage.fragment(a);return this},fragment:function(a,b,e){a=a instanceof THREE.Material?a:tQuery.createFragmentMaterial(this,a,b,e);this._stage.fragment(a);return this},raytrace:function(a,b,e){a=a instanceof THREE.Material?a:tQuery.createRaytraceMaterial(this,a,b,e);this._stage.fragment(a);return this},downsample:function(a){if(!a.autoSize()){var b=a.size();this._options.width=b.width;
this._options.height=b.height}b=a.scale();this.scale(2*b);a=tQuery.createDownsampleMaterial(a,this);this._stage.fragment(a);return this},upsample:function(a){if(!a.autoSize()){var b=a.size();this._options.width=b.width;this._options.height=b.height}b=a.scale();this.scale(0.5*b);a=tQuery.createUpsampleMaterial(a,this);this._stage.fragment(a);return this},read:function(a){return this._stage.read(a)},uniform:function(){return this._stage.uniform()},render:function(){this._stage.render();return this},
destroy:function(){this._stage.destroy();this._stage=null;this.queue.remove(this);this.trigger("destroy");return this}});tQuery.pluginsInstanceOn(ThreeRTT.World);tQuery.MicroeventMixin(ThreeRTT.World.prototype);ThreeRTT.RenderQueue=function(a){this.world=a;this.queue=[];this.callback=null;this.renderer=a.tRenderer()};
ThreeRTT.RenderQueue.prototype={add:function(a){this.queue.push(a);this.sort();this.init()},remove:function(a){this.queue.splice(this.queue.indexOf(a),1);this.cleanup()},init:function(){var a=this.queue,b=this.world;a.length&&!this.callback&&b.loop().hookPreRender(this.callback=function(){_.each(a,function(a){a.render()})})},cleanup:function(){var a=this.world;!this.queue.length&&this.callback&&(a.loop().unhookPreRender(this.callback),this.callback=null)},sort:function(){this.queue.sort(function(a,
b){return a.order-b.order})}};ThreeRTT.RenderQueue.bind=function(a){return a.__rttRenderQueue?a.__rttRenderQueue:a.__rttRenderQueue=new ThreeRTT.RenderQueue(a)};tQuery.World.registerInstance("rtt",function(a){return tQuery.createRTT(this,a)});tQuery.World.registerInstance("compose",function(a,b,e,f){a=tQuery.createComposeRTT(a,b,e,f);this.add(a);return a});tQuery.World.registerInstance("display",function(a,b,e){a=tQuery.createDisplayRTT(a,b,e);this.add(a);return a});
tQuery.registerStatic("createRTT",function(a,b){return new ThreeRTT.World(a,b)});tQuery.registerStatic("createComposeRTT",function(a,b,e,f){return new ThreeRTT.Compose(a,b,e,f)});tQuery.registerStatic("createDisplayRTT",function(a,b,e){return new ThreeRTT.Display(a,b,e)});tQuery.registerStatic("createShaderMaterial",function(a,b,e,f,h){return new ThreeRTT.FragmentMaterial(a,b,e,f,h)});tQuery.registerStatic("createFragmentMaterial",function(a,b,e,f){return new ThreeRTT.FragmentMaterial(a,b,e,f)});
tQuery.registerStatic("createRaytraceMaterial",function(a,b,e,f){return new ThreeRTT.RaytraceMaterial(a,b,e,f)});tQuery.registerStatic("createDownsampleMaterial",function(a,b){return new ThreeRTT.DownsampleMaterial(a,b)});tQuery.registerStatic("createUpsampleMaterial",function(a,b){return new ThreeRTT.UpsampleMaterial(a,b)});tQuery.registerStatic("createScaleMaterial",function(a,b,e){return new ThreeRTT.DownsampleMaterial(a,b,e)});
